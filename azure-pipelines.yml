trigger:
- main

pool:
  name: Default  # Tu agente local, por ejemplo "MacBook-Pro-de-Santos"

stages:
# =====================
# üß± BUILD & TEST
# =====================
- stage: BuildAndTest
  displayName: "üèóÔ∏è Build & Test"
  jobs:
  - job: Build
    steps:
    - checkout: self

    # === BACKEND ===
    - script: |
        echo "üß© Compilando API .NET..."
        cd Marketplace.Api
        dotnet restore
        dotnet build --no-restore
        dotnet test --no-build --logger "trx;LogFileName=test_results.trx"
      displayName: "Build & Test Backend"

    # === FRONTEND ===
    - script: |
        echo "üß© Instalando Node.js 18..."
        brew install node@18 || true
        export PATH="/opt/homebrew/opt/node@18/bin:$PATH"
        node -v
        npm -v
      displayName: "Instalar Node.js 18"

    - script: |
        echo "üß± Construyendo Frontend..."
        cd marketplace.frontend
        npm install
        npm run build
        mkdir -p ../marketplace-drop/frontend
        cp -r dist/* ../marketplace-drop/frontend/
      displayName: "Build Frontend (solo archivos finales)"

    # === PUBLICAR ARTIFACT ===
    - task: PublishBuildArtifacts@1
      displayName: "üì¶ Publicar Artifact Optimizado"
      inputs:
        PathtoPublish: 'marketplace-drop'
        ArtifactName: 'marketplace'
        publishLocation: 'Container'
      condition: succeeded()

# =====================
# üöÄ DEPLOY QA
# =====================
- stage: QA_Deploy
  displayName: "Deploy QA"
  dependsOn: BuildAndTest
  condition: succeeded()
  jobs:
  - job: QA
    steps:
    - script: |
        echo "Desplegando a entorno QA..."
        echo "Simulaci√≥n de despliegue QA completada ‚úÖ"
      displayName: "Deploy QA Job"

# =====================
# üöÄ DEPLOY PRODUCCI√ìN
# =====================
- stage: PROD_Deploy
  displayName: "Deploy Producci√≥n"
  dependsOn: QA_Deploy
  condition: succeeded()
  jobs:
  - job: PROD
    steps:
    - script: |
        echo "Desplegando a Producci√≥n..."
        echo "Simulaci√≥n de despliegue Producci√≥n completada ‚úÖ"
      displayName: "Deploy PROD Job"
